<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AO3 èŠå¤©ç”Ÿæˆå™¨_Gred</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* =========================================
           AO3 Work Skin CSS (æ ‡å‡†æ ·å¼)
           ========================================= */
        #workskin .phone-container { width: 350px; height: 650px; margin: 0 auto; border: 1px solid #ddd; border-radius: 10px; overflow: hidden; font-family: "Segoe UI", sans-serif; position: relative; display: flex; flex-direction: column; background-color: #f5f5f5; }
        #workskin .skin-wechat { background-color: #ededed; }
        #workskin .skin-wechat .header { background-color: #ededed; color: #000; border-bottom: 1px solid #dcdcdc; }
        #workskin .skin-wechat .scrollable-content { background-color: #ededed; }
        #workskin .skin-wechat .bubble.mine { background-color: #95ec69; color: #000; border: 1px solid #8ad961; }
        #workskin .skin-wechat .bubble.other { background-color: #fff; color: #000; border: 1px solid #e0e0e0; }
        #workskin .skin-qq { background-color: #f2f4f5; }
        #workskin .skin-qq .header { background-color: #fff; color: #000; border-bottom: 1px solid #eee; }
        #workskin .skin-qq .scrollable-content { background-color: #f2f4f5; }
        #workskin .skin-qq .bubble.mine { background-color: #cce9ff; color: #000; border: none; }
        #workskin .skin-qq .bubble.other { background-color: #fff; color: #000; border: none; }
        #workskin .header { padding: 0 15px; height: 50px; flex-shrink: 0; z-index: 10; display: flex; align-items: center; justify-content: space-between; }
        #workskin .header-left { display: flex; align-items: center; }
        #workskin .header-title { font-size: 17px; font-weight: bold; margin-right: 5px; }
        #workskin .status-icon { font-size: 14px; cursor: default; }
        #workskin .header-menu { font-size: 20px; font-weight: bold; letter-spacing: 2px; color: #333; }
        #workskin .header p { margin: 0; padding: 0; display: inline; }
        #workskin .scrollable-content { overflow-y: auto; padding: 15px 12px; flex-grow: 1; display: flex; flex-direction: column; }
        #workskin .msg-row { display: flex; align-items: flex-start; margin-bottom: 8px; flex-shrink: 0; }
        #workskin .msg-row.left { flex-direction: row; }
        #workskin .msg-row.right { flex-direction: row-reverse; }
        #workskin .msg-row p { margin: 0; padding: 0; }
        #workskin .avatar-box { width: 40px; height: 40px; flex-shrink: 0; }
        #workskin .msg-row.left .avatar-box { margin-right: 10px; }
        #workskin .msg-row.right .avatar-box { margin-left: 10px; }
        #workskin .avatar-box img { width: 40px; height: 40px; border-radius: 5px; border: none; display: block; object-fit: cover; }
        #workskin .content-col { display: flex; flex-direction: column; max-width: 75%; }
        #workskin .msg-row.left .content-col { align-items: flex-start; }
        #workskin .msg-row.right .content-col { align-items: flex-end; }
        #workskin .char-name { font-size: 12px; color: #999; margin-bottom: 2px; margin-left: 2px; line-height: 1.2; }
        #workskin .msg-row.right .char-name { display: none; }
        #workskin .bubble { padding: 9px 12px; border-radius: 8px; font-size: 15px; line-height: 1.4; word-wrap: break-word; display: inline-block; text-align: left;}
        #workskin .bubble img { max-width: 100%; height: auto; border-radius: 4px; display: block; }
        #workskin .bubble p { margin: 0; }
        #workskin .audio-bubble { display: flex; align-items: center; min-width: 100px; cursor: default; padding: 8px 10px; }
        #workskin .play-icon { width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-left: 10px solid #000; margin-right: 8px; }
        #workskin .wave-visual { font-family: monospace; font-weight: bold; letter-spacing: -2px; color: #000; opacity: 0.7; font-size: 14px; margin-right: 10px; }
        #workskin .duration-text { font-size: 14px; color: #000; }
        #workskin .transcribed-text { margin-top: 5px; background-color: #e5e5e5; color: #000; padding: 6px 8px; border-radius: 6px; font-size: 14px; line-height: 1.4; }
        #workskin .bubble.redpacket { background-color: #fa9d3b !important; padding: 0 !important; width: 230px; border: none !important; display: flex; flex-direction: column; overflow: hidden; border-radius: 8px; }
        #workskin .rp-content { padding: 15px; display: flex; align-items: center; }
        #workskin .rp-icon { width: 34px; height: 42px; background-color: #e54d42; border-radius: 4px; position: relative; flex-shrink: 0; display: flex; justify-content: center; align-items: center; margin-right: 12px; }
        #workskin .rp-icon::after { content: ""; width: 12px; height: 12px; background-color: #f8d757; border-radius: 50%; }
        #workskin .rp-text { color: #fff; font-size: 16px; font-weight: 500; line-height: 1.2; }
        #workskin .rp-footer { background-color: rgba(255,255,255,0.05); border-top: 1px solid rgba(255,255,255,0.15); padding: 4px 15px; color: rgba(255,255,255,0.8); font-size: 11px; }

        /* =========================================
           ç¼–è¾‘å™¨ UI
           ========================================= */
        body { font-family: "Segoe UI", sans-serif; background: #eef2f5; display: flex; height: 100vh; margin: 0; overflow: hidden; }
        .sidebar { width: 420px; background: #fff; border-right: 1px solid #ccc; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .preview { flex: 1; display: flex; justify-content: center; align-items: center; background: #e0e0e0; padding: 20px; }
        .panel-box { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fafafa; }
        .panel-title { font-weight: bold; font-size: 14px; margin-bottom: 10px; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        label { font-size: 12px; font-weight: bold; color: #666; display: block; margin-bottom: 3px; }
        input[type="text"], select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; font-size: 13px; }
        .row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px;} 
        button { cursor: pointer; padding: 8px; border: none; border-radius: 4px; font-size: 13px; font-weight: bold; width: 100%; margin-top:5px; }
        
        .btn-green { background: #28a745; color: white; }
        .btn-blue { background: #007bff; color: white; }
        .btn-gray { background: #6c757d; color: white; }
        .btn-orange { background: #fd7e14; color: white; }
        .btn-purple { background: #6f42c1; color: white; }
        .btn-red-outline { background: #fff; border: 1px solid #dc3545; color: #dc3545; padding: 2px 8px; font-size: 12px; width: auto; margin:0;}

        /* æ ‡ç­¾æ ·å¼ */
        .tag { font-size: 10px; padding: 2px 4px; border-radius: 3px; margin-right: 5px; font-weight: bold; }
        .tag-local { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; } /* æ©™è‰²-æœ¬åœ° */
        .tag-link { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }   /* ç»¿è‰²-å¤–é“¾ */
        
        .msg-list-item { background: #f9f9f9; border-bottom: 1px solid #eee; padding: 8px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .char-list-item { background: #fff; border: 1px solid #eee; padding: 5px 8px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-radius: 4px; }
        .char-mini-av { width: 24px; height: 24px; border-radius: 3px; margin-right: 4px; vertical-align: middle; background: #ddd; object-fit: cover; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 600px; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; gap: 10px; }
        .code-area { width: 100%; height: 200px; background: #222; color: #0f0; font-family: monospace; padding: 10px; border: none; border-radius: 4px; white-space: pre-wrap; word-break: break-all; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3>AO3 èŠå¤©ç”Ÿæˆå™¨ (V Pro)</h3>
        
        <div class="panel-box">
            <div class="panel-title">1. è®¾ç½®</div>
            <label>çš®è‚¤é£æ ¼</label>
            <select id="themeSelect" onchange="renderAll()">
                <option value="skin-qq">QQ (ç™½é¡¶/è“æ³¡æ³¡)</option>
                <option value="skin-wechat">å¾®ä¿¡ (ç°é¡¶/ç»¿æ³¡æ³¡)</option>
            </select>
            
            <label>ç¾¤å / æ ‡é¢˜</label>
            <input type="text" id="chatTitle" value="æ–°ç¾¤èŠ" placeholder="è¾“å…¥ç¾¤å..." oninput="renderAll()">
            
            <div class="row">
                <div style="flex:1">
                    <label>çŠ¶æ€</label>
                    <select id="statusSelect" onchange="renderAll()">
                        <option value="">(æ— )</option>
                        <option value="ğŸŸ¢">åœ¨çº¿ (ğŸŸ¢)</option>
                        <option value="ğŸ•“">ç¦»å¼€ (ğŸ•“)</option>
                        <option value="â›”">å¿™ç¢Œ (â›”)</option>
                        <option value="ğŸš«">è¯·å‹¿æ‰“æ‰° (ğŸš«)</option>
                        <option value="custom">è‡ªå®šä¹‰...</option>
                    </select>
                </div>
                <div style="flex:1; display:none;" id="customStatusDiv">
                    <label>å›¾æ ‡</label>
                    <input type="text" id="customStatusInput" placeholder="Emoji" oninput="renderAll()">
                </div>
            </div>
            <button class="btn-gray" onclick="showCSS()">è·å– AO3 Work Skin CSS</button>
        </div>

        <div class="panel-box">
            <div class="panel-title">2. è§’è‰²ç®¡ç†</div>
            <div class="row">
                <input type="text" id="charName" placeholder="è§’è‰²å" style="flex:2">
                <select id="charSide" style="flex:1"><option value="left">å·¦</option><option value="right">å³</option></select>
            </div>
            <div class="row">
                <input type="text" id="charAvatar" placeholder="å›¾ç‰‡å¤–é“¾ (http) æˆ– ç‚¹å‡»ä¸Šä¼ " style="flex:2" oninput="checkAvatarType()">
                <input type="file" id="avatarUpload" accept="image/*" style="display:none" onchange="handleFileSelect(this)">
                <button class="btn-blue" onclick="document.getElementById('avatarUpload').click()" style="width: auto; padding: 0 10px; margin:0;">ğŸ“‚ ä¸Šä¼ æœ¬åœ°</button>
            </div>
            <p id="avatarTip" style="font-size:11px; color:#666; margin-top:-5px; margin-bottom:8px;">æç¤ºï¼šè¯·é€‰æ‹©å›¾ç‰‡æ¥æº</p>
            
            <button class="btn-green" onclick="addChar()">æ·»åŠ è§’è‰²</button>
            <div id="charListDisplay" style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;"></div>
        </div>

        <div class="panel-box">
            <div class="panel-title">3. å‘é€æ¶ˆæ¯</div>
            <div class="row">
                <select id="senderSelect" style="flex:1"></select>
                <select id="msgType" style="flex:1" onchange="toggleInput()">
                    <option value="text">æ–‡å­—</option>
                    <option value="redpacket">ğŸ§§ çº¢åŒ…</option>
                    <option value="voice">è¯­éŸ³+ç¿»è¯‘</option>
                    <option value="image">å›¾ç‰‡</option>
                </select>
            </div>
            
            <div id="input-text"><textarea id="textContent" placeholder="è¾“å…¥å†…å®¹..."></textarea></div>
            
            <div id="input-redpacket" style="display:none">
                <label>ç¥ç¦è¯­</label>
                <input type="text" id="rpMain" value="æ­å–œå‘è´¢">
                <label>åº•éƒ¨æè¿°</label>
                <input type="text" id="rpSub" value="å¾®ä¿¡çº¢åŒ…">
            </div>

            <div id="input-voice" style="display:none">
                <input type="text" id="voiceDuration" placeholder="æ—¶é•¿ (å¦‚ 16&quot;)">
                <textarea id="voiceText" placeholder="è¯­éŸ³è½¬æ–‡å­—å†…å®¹..."></textarea>
            </div>
            <div id="input-image" style="display:none"><input type="text" id="imgUrl" placeholder="å›¾ç‰‡ URL..."></div>
            
            <button class="btn-blue" onclick="sendMsg()">å‘é€æ¶ˆæ¯</button>
            <div id="msgList" style="margin-top:10px; max-height: 150px; overflow-y:auto; border:1px solid #eee;"></div>
            
            <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
                <label>å¯¼å‡ºæ–‡ä»¶å</label>
                <div class="row">
                    <input type="text" id="exportFilename" value="chat_log" placeholder="æ–‡ä»¶å" style="flex:2">
                    <span style="line-height:30px; font-size:12px; color:#666;">.html / .png</span>
                </div>
                <div class="row">
                    <button class="btn-green" onclick="generateAO3Code()">ğŸ“‹ å¤åˆ¶ AO3 ä»£ç  (å¤–é“¾)</button>
                    <button class="btn-gray" onclick="saveImage()">ğŸ–¼ï¸ å­˜ä¸ºå›¾ç‰‡ (æœ¬åœ°)</button>
                </div>
                <button class="btn-purple" onclick="downloadHTML()">ğŸ’¾ å¯¼å‡º .html æ–‡ä»¶ (å®Œæ•´å¤‡ä»½)</button>
            </div>
        </div>

        <div class="panel-box" style="border-color: #fd7e14;">
            <div class="panel-title" style="color:#fd7e14">4. å¯¼å…¥/æ¢å¤å­˜æ¡£</div>
            <p style="font-size:12px; color:#666;">å°†å¯¼å‡ºçš„ä»£ç æˆ– HTML æ–‡ä»¶å†…å®¹ç²˜è´´åˆ°æ­¤å¤„ã€‚</p>
            <textarea id="importArea" placeholder="ç²˜è´´ä»£ç ..." style="height: 60px;"></textarea>
            <button class="btn-orange" onclick="importHTML()">è§£æå¹¶æ¢å¤</button>
        </div>
    </div>

    <div class="preview">
        <div id="workskin">
            <div id="previewContainer" class="phone-container skin-qq">
                <div class="header">
                    <div class="header-left">
                        <span class="header-title" id="dispTitle">æ–°ç¾¤èŠ</span>
                        <span class="status-icon" id="dispStatus"></span>
                    </div>
                    <div class="header-menu">â€¢â€¢â€¢</div>
                </div>
                <div class="scrollable-content" id="chatContent"></div>
            </div>
        </div>
    </div>

    <div id="codeModal" class="modal">
        <div class="modal-box">
            <h3 id="modalTitle">ä»£ç </h3>
            <p id="modalDesc" style="font-size:12px; color:#666;"></p>
            <textarea class="code-area" id="finalCode"></textarea>
            <div class="row" style="justify-content: flex-end;">
                <button class="btn-gray" onclick="document.getElementById('codeModal').style.display='none'" style="width:auto;">å…³é—­</button>
                <button class="btn-blue" onclick="copyCode()" style="width:auto;">å¤åˆ¶</button>
            </div>
        </div>
    </div>

    <script>
        // é»˜è®¤å¤´åƒ (Base64)
        const DEFAULT_AVATAR = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRFzMzM////040qqAAAAAJ0Uk5T/wDltzBKAAAAJklEQVR42uzBgQAAAACAop/6QlVAAAAAAAAAAAAAAAAAAACwdQYMwAABnM7V7AAAAABJRU5ErkJggg==";
        
        // AO3 CSS (ç”¨äºå¯¼å‡º HTML æ–‡ä»¶)
        const ao3Css = `
#workskin .phone-container { width: 350px; height: 650px; margin: 0 auto; border: 1px solid #ddd; border-radius: 10px; overflow: hidden; font-family: sans-serif; position: relative; display: flex; flex-direction: column; background-color: #f5f5f5; }
#workskin .skin-wechat { background-color: #ededed; }
#workskin .skin-wechat .header { background-color: #ededed; color: #000; border-bottom: 1px solid #dcdcdc; }
#workskin .skin-wechat .scrollable-content { background-color: #ededed; }
#workskin .skin-wechat .bubble.mine { background-color: #95ec69; color: #000; border: 1px solid #8ad961; }
#workskin .skin-wechat .bubble.other { background-color: #fff; color: #000; border: 1px solid #e0e0e0; }
#workskin .skin-qq { background-color: #f2f4f5; }
#workskin .skin-qq .header { background-color: #fff; color: #000; border-bottom: 1px solid #eee; }
#workskin .skin-qq .scrollable-content { background-color: #f2f4f5; }
#workskin .skin-qq .bubble.mine { background-color: #cce9ff; color: #000; border: none; }
#workskin .skin-qq .bubble.other { background-color: #fff; color: #000; border: none; }
#workskin .header { padding: 0 15px; height: 50px; flex-shrink: 0; z-index: 10; display: flex; align-items: center; justify-content: space-between; }
#workskin .header-left { display: flex; align-items: center; }
#workskin .header-title { font-size: 17px; font-weight: bold; margin-right: 5px; }
#workskin .status-icon { font-size: 14px; cursor: default; }
#workskin .header-menu { font-size: 20px; font-weight: bold; letter-spacing: 2px; color: #333; }
#workskin .header p { margin: 0; padding: 0; display: inline; }
#workskin .scrollable-content { overflow-y: auto; padding: 15px 12px; flex-grow: 1; display: flex; flex-direction: column; }
#workskin .msg-row { display: flex; align-items: flex-start; margin-bottom: 8px; flex-shrink: 0; }
#workskin .msg-row.left { flex-direction: row; }
#workskin .msg-row.right { flex-direction: row-reverse; }
#workskin .msg-row p { margin: 0; padding: 0; }
#workskin .avatar-box { width: 40px; height: 40px; flex-shrink: 0; }
#workskin .msg-row.left .avatar-box { margin-right: 10px; }
#workskin .msg-row.right .avatar-box { margin-left: 10px; }
#workskin .avatar-box img { width: 40px; height: 40px; border-radius: 5px; border: none; display: block; }
#workskin .content-col { display: flex; flex-direction: column; max-width: 75%; }
#workskin .msg-row.left .content-col { align-items: flex-start; }
#workskin .msg-row.right .content-col { align-items: flex-end; }
#workskin .char-name { font-size: 12px; color: #999; margin-bottom: 2px; margin-left: 2px; line-height: 1.2; }
#workskin .msg-row.right .char-name { display: none; }
#workskin .bubble { padding: 9px 12px; border-radius: 8px; font-size: 15px; line-height: 1.4; word-wrap: break-word; display: inline-block; text-align: left; }
#workskin .bubble img { max-width: 100%; height: auto; border-radius: 4px; display: block; }
#workskin .bubble p { margin: 0; }
#workskin .audio-bubble { display: flex; align-items: center; min-width: 100px; cursor: default; padding: 8px 10px; }
#workskin .play-icon { width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-left: 10px solid #000; margin-right: 8px; }
#workskin .wave-visual { font-family: monospace; font-weight: bold; letter-spacing: -2px; color: #000; opacity: 0.7; font-size: 14px; margin-right: 10px; }
#workskin .duration-text { font-size: 14px; color: #000; }
#workskin .transcribed-text { margin-top: 5px; background-color: #e5e5e5; color: #000; padding: 6px 8px; border-radius: 6px; font-size: 14px; line-height: 1.4; }
#workskin .bubble.redpacket { background-color: #fa9d3b !important; padding: 0 !important; width: 230px; border: none !important; display: flex; flex-direction: column; overflow: hidden; border-radius: 8px; }
#workskin .rp-content { padding: 15px; display: flex; align-items: center; }
#workskin .rp-icon { width: 34px; height: 42px; background-color: #e54d42; border-radius: 4px; position: relative; flex-shrink: 0; display: flex; justify-content: center; align-items: center; margin-right: 12px; }
#workskin .rp-icon::after { content: ""; width: 12px; height: 12px; background-color: #f8d757; border-radius: 50%; }
#workskin .rp-text { color: #fff; font-size: 16px; font-weight: 500; line-height: 1.2; }
#workskin .rp-footer { background-color: rgba(255,255,255,0.05); border-top: 1px solid rgba(255,255,255,0.15); padding: 4px 15px; color: rgba(255,255,255,0.8); font-size: 11px; }
`;

        let characters = [
            { id: 1, name: "è§’è‰² A", side: "left", avatar: DEFAULT_AVATAR, type: 'local' },
            { id: 2, name: "è§’è‰² B (æˆ‘)", side: "right", avatar: DEFAULT_AVATAR, type: 'local' }
        ];
        let messages = [
             { senderId: 1, type: 'text', content: 'V Pro ç‰ˆï¼šæ”¯æŒåŒºåˆ†å¤–é“¾ä¸æœ¬åœ°å›¾ç‰‡ã€‚' }
        ];

        window.onload = function() {
            renderCharSelect();
            renderCharListDisplay();
            renderAll();
        };

        // æ£€æŸ¥è¾“å…¥æ¡†å†…å®¹åˆ¤æ–­æ˜¯å¤–é“¾è¿˜æ˜¯æœ¬åœ°ï¼ˆä»…åšæç¤ºï¼‰
        function checkAvatarType() {
            let val = document.getElementById('charAvatar').value;
            let tip = document.getElementById('avatarTip');
            if(val.startsWith('data:image')) {
                tip.innerHTML = "<span style='color:#fd7e14'>ğŸŸ  æ£€æµ‹åˆ°æœ¬åœ°å›¾ç‰‡æ•°æ® (é€‚åˆç”Ÿæˆé•¿å›¾/HTMLæ–‡ä»¶)</span>";
            } else if (val.startsWith('http')) {
                tip.innerHTML = "<span style='color:#28a745'>ğŸŸ¢ æ£€æµ‹åˆ°å¤–é“¾ (é€‚åˆ AO3)</span>";
            } else {
                tip.innerHTML = "æç¤ºï¼šè¯·é€‰æ‹©å›¾ç‰‡æ¥æº";
            }
        }

        // å¤„ç†æœ¬åœ°ä¸Šä¼ 
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('charAvatar').value = e.target.result;
                    checkAvatarType();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function toggleInput() {
            let t = document.getElementById('msgType').value;
            ['text','voice','image','redpacket'].forEach(id => document.getElementById('input-'+id).style.display = 'none');
            document.getElementById('input-'+t).style.display = 'block';
        }

        function addChar() {
            let name = document.getElementById('charName').value;
            let avatar = document.getElementById('charAvatar').value || DEFAULT_AVATAR;
            let side = document.getElementById('charSide').value;
            if(!name) return alert('è¯·è¾“å…¥è§’è‰²åå­—');

            // è‡ªåŠ¨åˆ¤æ–­ç±»å‹
            let type = 'local'; // é»˜è®¤æœ¬åœ°
            if (avatar.startsWith('http')) type = 'link';

            characters.push({id: Date.now(), name, side, avatar, type});
            renderCharSelect();
            renderCharListDisplay();
            document.getElementById('charName').value = '';
            document.getElementById('charAvatar').value = '';
            document.getElementById('avatarTip').innerText = "æç¤ºï¼šè¯·é€‰æ‹©å›¾ç‰‡æ¥æº";
        }

        function deleteChar(id) {
            characters = characters.filter(c => c.id !== id);
            renderCharSelect();
            renderCharListDisplay();
        }

        function renderCharListDisplay() {
            let container = document.getElementById('charListDisplay');
            container.innerHTML = '';
            characters.forEach(c => {
                let div = document.createElement('div');
                div.className = 'char-list-item';
                // æ ‡ç­¾æ˜¾ç¤º
                let tag = c.type === 'link' 
                    ? `<span class="tag tag-link">[å¤–é“¾]</span>` 
                    : `<span class="tag tag-local">[æœ¬åœ°]</span>`;
                
                div.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <img src="${c.avatar}" class="char-mini-av">
                        <div style="display:flex; flex-direction:column;">
                            <span>${c.name} (${c.side === 'left' ? 'å·¦' : 'å³'})</span>
                            <div style="margin-top:2px;">${tag}</div>
                        </div>
                    </div>
                    <button class="btn-red-outline" onclick="deleteChar(${c.id})">åˆ </button>
                `;
                container.appendChild(div);
            });
        }

        function renderCharSelect() {
            let s = document.getElementById('senderSelect');
            s.innerHTML = '';
            characters.forEach(c => s.innerHTML += `<option value="${c.id}">${c.name}</option>`);
        }

        function sendMsg() {
            let sid = document.getElementById('senderSelect').value;
            if (!sid) return alert("è¯·å…ˆæ·»åŠ è§’è‰²");
            let type = document.getElementById('msgType').value;
            let data = { senderId: parseInt(sid), type };
            
            if(type === 'text') {
                data.content = document.getElementById('textContent').value;
                document.getElementById('textContent').value = '';
            } else if (type === 'redpacket') {
                data.main = document.getElementById('rpMain').value;
                data.sub = document.getElementById('rpSub').value;
            } else if (type === 'voice') {
                data.duration = document.getElementById('voiceDuration').value || '10"';
                data.text = document.getElementById('voiceText').value;
                document.getElementById('voiceText').value = '';
            } else if (type === 'image') {
                data.url = document.getElementById('imgUrl').value;
                document.getElementById('imgUrl').value = '';
            }
            if(!data.content && !data.text && !data.url && !data.main) return;
            messages.push(data);
            renderAll();
        }

        function renderAll() {
            let theme = document.getElementById('themeSelect').value;
            let container = document.getElementById('previewContainer');
            container.className = `phone-container ${theme}`;

            document.getElementById('dispTitle').innerText = document.getElementById('chatTitle').value;
            
            let statusVal = document.getElementById('statusSelect').value;
            let customDiv = document.getElementById('customStatusDiv');
            if (statusVal === 'custom') {
                customDiv.style.display = 'block';
                statusVal = document.getElementById('customStatusInput').value;
            } else {
                customDiv.style.display = 'none';
            }
            document.getElementById('dispStatus').innerText = statusVal;

            let content = document.getElementById('chatContent');
            let list = document.getElementById('msgList');
            content.innerHTML = '';
            list.innerHTML = '';

            messages.forEach((msg, idx) => {
                let char = characters.find(c => c.id === msg.senderId);
                if (!char) char = { name: "æœªçŸ¥", side: "left", avatar: DEFAULT_AVATAR, type: 'local' };
                let inner = '';
                
                if(msg.type === 'text') {
                    let safeText = msg.content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    inner = `<div class="bubble ${char.side === 'right' ? 'mine' : 'other'}">${safeText}</div>`;
                } else if (msg.type === 'redpacket') {
                    inner = `<div class="bubble redpacket"><div class="rp-content"><div class="rp-icon"></div><div class="rp-text">${msg.main}</div></div><div class="rp-footer">${msg.sub}</div></div>`;
                } else if (msg.type === 'voice') {
                    inner = `<div class="bubble audio-bubble ${char.side === 'right' ? 'mine' : 'other'}"><div class="play-icon"></div><div class="wave-visual">|||||||||||</div><div class="duration-text">${msg.duration}</div></div><div class="transcribed-text">${msg.text}</div>`;
                } else if (msg.type === 'image') {
                    inner = `<div class="bubble ${char.side === 'right' ? 'mine' : 'other'}"><img src="${msg.url}"></div>`;
                }

                let row = `
                    <div class="msg-row ${char.side}">
                        <div class="avatar-box"><img src="${char.avatar}"></div>
                        <div class="content-col">
                            <div class="char-name">${char.name}</div>
                            ${inner}
                        </div>
                    </div>
                `;
                content.innerHTML += row;

                let txt = msg.type==='text' ? msg.content : (msg.type==='redpacket' ? '[çº¢åŒ…]' : `[${msg.type}]`);
                list.innerHTML += `<div class="msg-list-item"><span>${char.name}: ${txt.substring(0,10)}</span><button style="color:red" onclick="messages.splice(${idx},1);renderAll()">X</button></div>`;
            });
            content.scrollTop = content.scrollHeight;
        }

        // === æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆ AO3 ä»£ç  (å¸¦æ£€æŸ¥) ===
        function generateAO3Code() {
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°å›¾ç‰‡æ··å…¥
            let hasLocal = characters.some(c => c.type === 'local' && messages.some(m => m.senderId === c.id));
            if (hasLocal) {
                let confirm = window.confirm("âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°æ‚¨ä½¿ç”¨äº†ã€æœ¬åœ°å›¾ç‰‡/æ©™è‰²æ ‡ç­¾ã€‘ã€‚\n\nAO3 ä¸æ”¯æŒç›´æ¥ç²˜è´´æœ¬åœ°å›¾ç‰‡ä»£ç ï¼Œå‘å¸ƒåå¤´åƒä¼šå˜æˆç©ºç™½ã€‚\n\nå»ºè®®ï¼š\n1. è¯·ä½¿ç”¨å›¾åºŠå¤–é“¾ (ç»¿è‰²æ ‡ç­¾)ã€‚\n2. æˆ–è€…ä½¿ç”¨ã€å­˜ä¸ºå›¾ç‰‡ã€‘åŠŸèƒ½ç›´æ¥å‘å›¾ã€‚\n\næ˜¯å¦ä»ç„¶è¦è·å–ä»£ç ï¼Ÿ");
                if (!confirm) return;
            }

            let html = document.getElementById('previewContainer').outerHTML;
            html = html.replace('id="previewContainer"', '')
                       .replace('id="dispTitle"', '')
                       .replace('id="dispStatus"', '')
                       .replace('id="chatContent"', '');
            document.getElementById('modalTitle').innerText = "AO3 HTML ä»£ç ";
            document.getElementById('modalDesc').innerText = "å¤åˆ¶åˆ° AO3 HTML ç¼–è¾‘å™¨ä¸­ã€‚";
            document.getElementById('finalCode').value = html;
            document.getElementById('codeModal').style.display = 'flex';
        }

        // === æ ¸å¿ƒåŠŸèƒ½ï¼šå¯¼å‡ºä¸º .html æ–‡ä»¶ ===
        function downloadHTML() {
            let filename = document.getElementById('exportFilename').value || 'ao3_chat';
            if (!filename.endsWith('.html')) filename += '.html';

            // è·å–èŠå¤©éƒ¨åˆ†çš„ HTML
            let chatHtml = document.getElementById('previewContainer').outerHTML;
             // æ¸…ç† ID ä»¥é˜²å†²çª
            chatHtml = chatHtml.replace('id="previewContainer"', '')
                               .replace('id="dispTitle"', '')
                               .replace('id="dispStatus"', '')
                               .replace('id="chatContent"', '');

            // ç»„è£…æˆä¸€ä¸ªå®Œæ•´çš„ HTML æ–‡ä»¶
            let fullHtml = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${filename}</title>
<style>
/* åµŒå…¥ AO3 æ ·å¼ä»¥ä¾¿æœ¬åœ°é¢„è§ˆ */
${ao3Css}
body { background-color: #eef2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
#workskin { margin-top: 20px; margin-bottom: 20px; }
</style>
</head>
<body>
<div id="workskin">
${chatHtml}
</div>
</body>
</html>`;

            // åˆ›å»º Blob å¹¶ä¸‹è½½
            let blob = new Blob([fullHtml], {type: "text/html;charset=utf-8"});
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importHTML() {
            const html = document.getElementById('importArea').value;
            if(!html.includes('phone-container')) return alert("æ— æ•ˆçš„ä»£ç ");
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // æ¢å¤è®¾ç½®
            const container = doc.querySelector('.phone-container');
            if(container.classList.contains('skin-wechat')) document.getElementById('themeSelect').value = 'skin-wechat';
            else document.getElementById('themeSelect').value = 'skin-qq';

            const titleEl = doc.querySelector('.header-title');
            if(titleEl) document.getElementById('chatTitle').value = titleEl.innerText.trim();

            const statusEl = doc.querySelector('.status-icon');
            if(statusEl) {
                const sText = statusEl.innerText.trim();
                const opts = document.getElementById('statusSelect').options;
                let found = false;
                for(let i=0; i<opts.length; i++) {
                    if(opts[i].value === sText) {
                        document.getElementById('statusSelect').value = sText;
                        found = true;
                        break;
                    }
                }
                if(!found && sText) {
                    document.getElementById('statusSelect').value = 'custom';
                    document.getElementById('customStatusInput').value = sText;
                }
            }

            // é‡å»ºæ•°æ®
            characters = [];
            messages = [];
            const rows = doc.querySelectorAll('.msg-row');
            
            rows.forEach(row => {
                const isLeft = row.classList.contains('left');
                const imgEl = row.querySelector('.avatar-box img');
                const avatar = imgEl ? imgEl.src : DEFAULT_AVATAR;
                
                // æ¢å¤è§’è‰² (è‡ªåŠ¨åˆ¤æ–­ç±»å‹)
                let name = "æœªçŸ¥";
                const nameEl = row.querySelector('.char-name');
                if(nameEl) name = nameEl.innerText.trim();
                else if(!isLeft) name = "æˆ‘";

                let exists = characters.find(c => c.name === name && c.avatar === avatar);
                let sid;
                if(!exists) {
                    sid = Date.now() + Math.floor(Math.random()*1000);
                    // ç®€å•åˆ¤æ–­å¯¼å…¥çš„å›¾ç‰‡ç±»å‹
                    let type = avatar.startsWith('http') ? 'link' : 'local';
                    characters.push({ id: sid, name, side: isLeft ? 'left' : 'right', avatar, type });
                } else {
                    sid = exists.id;
                }

                // æ¢å¤æ¶ˆæ¯
                if(row.querySelector('.redpacket')) {
                    const rpText = row.querySelector('.rp-text').innerText.trim();
                    const rpFoot = row.querySelector('.rp-footer').innerText.trim();
                    messages.push({ senderId: sid, type: 'redpacket', main: rpText, sub: rpFoot });
                } else if(row.querySelector('.audio-bubble')) {
                    const dur = row.querySelector('.duration-text').innerText.trim();
                    const trans = row.querySelector('.transcribed-text').innerText.trim();
                    messages.push({ senderId: sid, type: 'voice', duration: dur, text: trans });
                } else if(row.querySelector('.bubble img')) {
                    const src = row.querySelector('.bubble img').src;
                    messages.push({ senderId: sid, type: 'image', url: src });
                } else {
                    const bubbleEl = row.querySelector('.bubble');
                    const txt = bubbleEl ? bubbleEl.innerText.trim() : "";
                    messages.push({ senderId: sid, type: 'text', content: txt });
                }
            });

            renderCharSelect();
            renderCharListDisplay();
            renderAll();
            alert("å¯¼å…¥æˆåŠŸï¼");
        }

        function showCSS() {
            document.getElementById('modalTitle').innerText = "Work Skin CSS";
            document.getElementById('modalDesc').innerText = "å¤åˆ¶åˆ° AO3 Skin é¡µé¢ã€‚";
            document.getElementById('finalCode').value = ao3Css;
            document.getElementById('codeModal').style.display = 'flex';
        }

        function copyCode() {
            document.getElementById('finalCode').select();
            document.execCommand('copy');
            alert('å·²å¤åˆ¶');
        }
        
        function saveImage() {
            let filename = document.getElementById('exportFilename').value || 'chat_log';
            if (typeof html2canvas === 'undefined') return alert("æ’ä»¶æœªåŠ è½½");
            html2canvas(document.querySelector("#workskin"), { useCORS: true, scale: 2 }).then(canvas => {
                let a = document.createElement('a');
                a.download = filename + '.png';
                a.href = canvas.toDataURL();
                a.click();
            });
        }
    </script>
</body>
</html>