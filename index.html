<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AO3 èŠå¤©ç”Ÿæˆå™¨ Gred</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* =========================================
           AO3 Work Skin CSS (æ ‡å‡†æ ·å¼)
           ========================================= */
        #workskin .phone-container { width: 350px; height: 650px; margin: 0 auto; border: 1px solid #ddd; border-radius: 10px; overflow: hidden; font-family: "Segoe UI", sans-serif; position: relative; display: flex; flex-direction: column; background-color: #f5f5f5; }
        #workskin .skin-wechat { background-color: #ededed; }
        #workskin .skin-wechat .header { background-color: #ededed; color: #000; border-bottom: 1px solid #dcdcdc; }
        #workskin .skin-wechat .scrollable-content { background-color: #ededed; }
        #workskin .skin-wechat .bubble.mine { background-color: #95ec69; color: #000; border: 1px solid #8ad961; }
        #workskin .skin-wechat .bubble.other { background-color: #fff; color: #000; border: 1px solid #e0e0e0; }
        
        /* å¾®ä¿¡æ ‡é¢˜å±…ä¸­ */
        #workskin .header { padding: 0 15px; height: 50px; flex-shrink: 0; z-index: 10; display: flex; align-items: center; justify-content: space-between; position: relative; }
        #workskin .skin-wechat .header-title { position: absolute; left: 50%; transform: translateX(-50%); text-align: center; width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        #workskin .skin-qq { background-color: #f2f4f5; }
        #workskin .skin-qq .header { background-color: #fff; color: #000; border-bottom: 1px solid #eee; }
        #workskin .skin-qq .scrollable-content { background-color: #f2f4f5; }
        #workskin .skin-qq .bubble.mine { background-color: #cce9ff; color: #000; border: none; }
        #workskin .skin-qq .bubble.other { background-color: #fff; color: #000; border: none; }
        
        #workskin .header-left { display: flex; align-items: center; }
        #workskin .header-title { font-size: 17px; font-weight: bold; margin-right: 5px; }
        #workskin .status-icon { font-size: 14px; cursor: default; }
        #workskin .header-menu { font-size: 20px; font-weight: bold; letter-spacing: 2px; color: #333; z-index: 11; }
        #workskin .header p { margin: 0; padding: 0; display: inline; }
        #workskin .scrollable-content { overflow-y: auto; padding: 15px 12px; flex-grow: 1; display: flex; flex-direction: column; }
        #workskin .msg-row { display: flex; align-items: flex-start; margin-bottom: 8px; flex-shrink: 0; }
        #workskin .msg-row.left { flex-direction: row; }
        #workskin .msg-row.right { flex-direction: row-reverse; }
        #workskin .msg-row p { margin: 0; padding: 0; }
        #workskin .avatar-box { width: 40px; height: 40px; flex-shrink: 0; }
        #workskin .msg-row.left .avatar-box { margin-right: 10px; }
        #workskin .msg-row.right .avatar-box { margin-left: 10px; }
        #workskin .avatar-box img { width: 40px; height: 40px; border-radius: 5px; border: none; display: block; object-fit: cover; }
        #workskin .content-col { display: flex; flex-direction: column; max-width: 75%; }
        #workskin .msg-row.left .content-col { align-items: flex-start; }
        #workskin .msg-row.right .content-col { align-items: flex-end; }
        #workskin .char-name { font-size: 12px; color: #999; margin-bottom: 2px; margin-left: 2px; line-height: 1.2; }
        #workskin .msg-row.right .char-name { display: none; }
        #workskin .bubble { padding: 9px 12px; border-radius: 8px; font-size: 15px; line-height: 1.4; word-wrap: break-word; display: inline-block; text-align: left;}
        #workskin .bubble img { max-width: 100%; height: auto; border-radius: 4px; display: block; }
        #workskin .bubble p { margin: 0; }
        #workskin .audio-bubble { display: flex; align-items: center; min-width: 100px; cursor: default; padding: 8px 10px; }
        #workskin .play-icon { width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-left: 10px solid #000; margin-right: 8px; }
        #workskin .wave-visual { font-family: monospace; font-weight: bold; letter-spacing: -2px; color: #000; opacity: 0.7; font-size: 14px; margin-right: 10px; }
        #workskin .duration-text { font-size: 14px; color: #000; }
        #workskin .transcribed-text { margin-top: 5px; background-color: #e5e5e5; color: #000; padding: 6px 8px; border-radius: 6px; font-size: 14px; line-height: 1.4; }
        #workskin .bubble.redpacket { background-color: #fa9d3b !important; padding: 0 !important; width: 230px; border: none !important; display: flex; flex-direction: column; overflow: hidden; border-radius: 8px; }
        #workskin .rp-content { padding: 15px; display: flex; align-items: center; }
        #workskin .rp-icon { width: 34px; height: 42px; background-color: #e54d42; border-radius: 4px; position: relative; flex-shrink: 0; display: flex; justify-content: center; align-items: center; margin-right: 12px; }
        #workskin .rp-icon::after { content: ""; width: 12px; height: 12px; background-color: #f8d757; border-radius: 50%; }
        #workskin .rp-text { color: #fff; font-size: 16px; font-weight: 500; line-height: 1.2; }
        #workskin .rp-footer { background-color: rgba(255,255,255,0.05); border-top: 1px solid rgba(255,255,255,0.15); padding: 4px 15px; color: rgba(255,255,255,0.8); font-size: 11px; }

        /* æ—¶é—´/ç³»ç»Ÿæç¤º */
        #workskin .time-row { text-align: center; margin: 15px 0 10px 0; width: 100%; clear: both; display: flex; justify-content: center; }
        #workskin .time-pill { background-color: rgba(0,0,0,0.15); color: #fff; font-size: 12px; padding: 3px 8px; border-radius: 4px; display: inline-block; max-width: 80%; }
        #workskin .skin-wechat .time-pill { background-color: #dadddf; color: #787a7d; }

        /* =========================================
           ç¼–è¾‘å™¨ UI
           ========================================= */
        body { font-family: "Segoe UI", sans-serif; background: #eef2f5; display: flex; height: 100vh; margin: 0; overflow: hidden; }
        .sidebar { width: 420px; background: #fff; border-right: 1px solid #ccc; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; }
        .preview { flex: 1; display: flex; justify-content: center; align-items: center; background: #e0e0e0; padding: 20px; }
        .panel-box { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fafafa; }
        .panel-title { font-weight: bold; font-size: 14px; margin-bottom: 10px; color: #333; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        label { font-size: 12px; font-weight: bold; color: #666; display: block; margin-bottom: 3px; }
        input[type="text"], select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; font-size: 13px; }
        .row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px;} 
        button { cursor: pointer; padding: 8px; border: none; border-radius: 4px; font-size: 13px; font-weight: bold; width: 100%; margin-top:5px; }
        
        .btn-green { background: #28a745; color: white; }
        .btn-blue { background: #007bff; color: white; }
        .btn-gray { background: #6c757d; color: white; }
        .btn-orange { background: #fd7e14; color: white; }
        .btn-purple { background: #6f42c1; color: white; }
        .btn-red-outline { background: #fff; border: 1px solid #dc3545; color: #dc3545; padding: 2px 8px; font-size: 12px; width: auto; margin:0;}
        .btn-edit { background: #fff; border: 1px solid #007bff; color: #007bff; padding: 2px 5px; font-size: 12px; width: auto; margin:0; margin-right: 2px; }

        .tag { font-size: 10px; padding: 2px 4px; border-radius: 3px; margin-right: 5px; font-weight: bold; }
        .tag-local { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .tag-link { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        
        .msg-list-item { background: #f9f9f9; border-bottom: 1px solid #eee; padding: 8px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; }
        .drag-handle { cursor: grab; color: #aaa; margin-right: 10px; font-size: 14px; padding: 0 5px; }
        .drag-handle:active { cursor: grabbing; color: #666; }
        .ghost-class { opacity: 0.5; background: #e0e0e0; }

        .char-list-item { background: #fff; border: 1px solid #eee; padding: 5px 8px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-radius: 4px; }
        .char-mini-av { width: 24px; height: 24px; border-radius: 3px; margin-right: 4px; vertical-align: middle; background: #ddd; object-fit: cover; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 600px; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; gap: 10px; }
        .code-area { width: 100%; height: 200px; background: #222; color: #0f0; font-family: monospace; padding: 10px; border: none; border-radius: 4px; white-space: pre-wrap; word-break: break-all; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3>AO3 èŠå¤©ç”Ÿæˆå™¨ (æ¢å›¾å¢å¼ºç‰ˆ)</h3>
        
        <div class="panel-box">
            <div class="panel-title">1. è®¾ç½®</div>
            <label>çš®è‚¤é£æ ¼</label>
            <select id="themeSelect" onchange="renderAll()">
                <option value="skin-qq">QQ (ç™½é¡¶/è“æ³¡æ³¡)</option>
                <option value="skin-wechat">å¾®ä¿¡ (ç°é¡¶/ç»¿æ³¡æ³¡/æ ‡é¢˜å±…ä¸­)</option>
            </select>
            
            <label>ç¾¤å / æ ‡é¢˜</label>
            <input type="text" id="chatTitle" value="æ–°ç¾¤èŠ" placeholder="è¾“å…¥ç¾¤å..." oninput="renderAll()">
            
            <div class="row">
                <div style="flex:1">
                    <label>çŠ¶æ€</label>
                    <select id="statusSelect" onchange="renderAll()">
                        <option value="">(æ— )</option>
                        <option value="ğŸŸ¢">åœ¨çº¿ (ğŸŸ¢)</option>
                        <option value="ğŸ•“">ç¦»å¼€ (ğŸ•“)</option>
                        <option value="â›”">å¿™ç¢Œ (â›”)</option>
                        <option value="ğŸš«">è¯·å‹¿æ‰“æ‰° (ğŸš«)</option>
                        <option value="custom">è‡ªå®šä¹‰...</option>
                    </select>
                </div>
                <div style="flex:1; display:none;" id="customStatusDiv">
                    <label>å›¾æ ‡</label>
                    <input type="text" id="customStatusInput" placeholder="Emoji" oninput="renderAll()">
                </div>
            </div>
            <button class="btn-gray" onclick="showCSS()">è·å– AO3 Work Skin CSS</button>
        </div>

        <div class="panel-box">
            <div class="panel-title">2. è§’è‰²ç®¡ç†</div>
            <div class="row">
                <input type="text" id="charName" placeholder="è§’è‰²å" style="flex:2">
                <select id="charSide" style="flex:1"><option value="left">å·¦</option><option value="right">å³</option></select>
            </div>
            <div class="row">
                <input type="text" id="charAvatar" placeholder="å›¾ç‰‡å¤–é“¾ (http) æˆ– ç‚¹å‡»ä¸Šä¼ " style="flex:2" oninput="checkAvatarType()">
                <input type="file" id="avatarUpload" accept="image/*" style="display:none" onchange="handleFileSelect(this)">
                <button class="btn-blue" onclick="document.getElementById('avatarUpload').click()" style="width: auto; padding: 0 10px; margin:0;">ğŸ“‚ ä¸Šä¼ æœ¬åœ°</button>
            </div>
            <p id="avatarTip" style="font-size:11px; color:#666; margin-top:-5px; margin-bottom:8px;">æç¤ºï¼šè¯·é€‰æ‹©å›¾ç‰‡æ¥æº</p>
            
            <button class="btn-green" onclick="addChar()">æ·»åŠ è§’è‰²</button>
            <div id="charListDisplay" style="margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px;"></div>
        </div>

        <div class="panel-box">
            <div class="panel-title">3. å‘é€æ¶ˆæ¯</div>
            <div class="row">
                <select id="senderSelect" style="flex:1"></select>
                <select id="msgType" style="flex:1" onchange="toggleInput()">
                    <option value="text">æ–‡å­—</option>
                    <option value="time">ğŸ•’ æ—¶é—´ / ç³»ç»Ÿæç¤º</option>
                    <option value="redpacket">ğŸ§§ çº¢åŒ…</option>
                    <option value="voice">è¯­éŸ³+ç¿»è¯‘</option>
                    <option value="image">å›¾ç‰‡</option>
                </select>
            </div>
            
            <div id="input-text"><textarea id="textContent" placeholder="è¾“å…¥å†…å®¹..."></textarea></div>
            
            <div id="input-time" style="display:none">
                <input type="text" id="timeContent" placeholder="ä¾‹å¦‚: 15:53 æˆ– æ˜¨å¤© 12:00">
                <p style="font-size:11px; color:#666;">æç¤ºï¼šå‘é€åå¯æŒ‰ä½ "â˜°" æ‹–åŠ¨åˆ°ä»»æ„ä½ç½®ã€‚</p>
            </div>
            
            <div id="input-redpacket" style="display:none">
                <label>ç¥ç¦è¯­</label>
                <input type="text" id="rpMain" value="æ­å–œå‘è´¢">
                <label>åº•éƒ¨æè¿°</label>
                <input type="text" id="rpSub" value="å¾®ä¿¡çº¢åŒ…">
            </div>

            <div id="input-voice" style="display:none">
                <input type="text" id="voiceDuration" placeholder="æ—¶é•¿ (å¦‚ 16&quot;)">
                <textarea id="voiceText" placeholder="è¯­éŸ³è½¬æ–‡å­—å†…å®¹..."></textarea>
            </div>

            <div id="input-image" style="display:none">
                <div class="row">
                    <input type="text" id="imgUrl" placeholder="å›¾ç‰‡é“¾æ¥ / ä¸Šä¼ åè‡ªåŠ¨å¡«å…¥æ•°æ®..." style="flex:2">
                    <input type="file" id="msgImgUpload" accept="image/*" style="display:none" onchange="handleMsgImgSelect(this)">
                    <button class="btn-blue" onclick="document.getElementById('msgImgUpload').click()" style="width: auto; padding: 0 10px; margin:0;">ğŸ“‚ ä¸Šä¼ æœ¬åœ°</button>
                </div>
                <p style="font-size:11px; color:#666;">æç¤ºï¼šæœ¬åœ°ä¸Šä¼ ä¼šè‡ªåŠ¨è½¬æ¢ä¸º Base64 ä»£ç ã€‚</p>
            </div>
            
            <button class="btn-blue" onclick="sendMsg()">å‘é€ / æ·»åŠ </button>
            
            <div id="msgList" style="margin-top:10px; max-height: 200px; overflow-y:auto; border:1px solid #eee;"></div>
            
            <div style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
                <label>å¯¼å‡ºæ–‡ä»¶å</label>
                <div class="row">
                    <input type="text" id="exportFilename" value="chat_log" placeholder="æ–‡ä»¶å" style="flex:2">
                    <span style="line-height:30px; font-size:12px; color:#666;">.html / .png</span>
                </div>
                <div class="row">
                    <button class="btn-green" onclick="generateAO3Code()">ğŸ“‹ å¤åˆ¶ AO3 ä»£ç  (å¤–é“¾)</button>
                    <button class="btn-gray" onclick="saveImage()">ğŸ–¼ï¸ å­˜ä¸ºå›¾ç‰‡ (æœ¬åœ°)</button>
                </div>
                <button class="btn-purple" onclick="downloadHTML()">ğŸ’¾ å¯¼å‡º .html æ–‡ä»¶ (å®Œæ•´å¤‡ä»½)</button>
            </div>
        </div>

        <div class="panel-box" style="border-color: #fd7e14;">
            <div class="panel-title" style="color:#fd7e14">4. å¯¼å…¥/æ¢å¤å­˜æ¡£</div>
            <p style="font-size:12px; color:#666;">å°†å¯¼å‡ºçš„ä»£ç æˆ– HTML æ–‡ä»¶å†…å®¹ç²˜è´´åˆ°æ­¤å¤„ã€‚</p>
            <textarea id="importArea" placeholder="ç²˜è´´ä»£ç ..." style="height: 60px;"></textarea>
            <button class="btn-orange" onclick="importHTML()">è§£æå¹¶æ¢å¤</button>
        </div>
    </div>

    <div class="preview">
        <div id="workskin">
            <div id="previewContainer" class="phone-container skin-qq">
                <div class="header">
                    <div class="header-left">
                        <span class="header-title" id="dispTitle">æ–°ç¾¤èŠ</span>
                        <span class="status-icon" id="dispStatus"></span>
                    </div>
                    <div class="header-menu">â€¢â€¢â€¢</div>
                </div>
                <div class="scrollable-content" id="chatContent"></div>
            </div>
        </div>
    </div>

    <div id="codeModal" class="modal">
        <div class="modal-box">
            <h3 id="modalTitle">ä»£ç </h3>
            <p id="modalDesc" style="font-size:12px; color:#666;"></p>
            <textarea class="code-area" id="finalCode"></textarea>
            <div class="row" style="justify-content: flex-end;">
                <button class="btn-gray" onclick="document.getElementById('codeModal').style.display='none'" style="width:auto;">å…³é—­</button>
                <button class="btn-blue" onclick="copyCode()" style="width:auto;">å¤åˆ¶</button>
            </div>
        </div>
    </div>

    <input type="file" id="changeCharAvatarInput" accept="image/*" style="display:none" onchange="handleChangeCharAvatarSelect(this)">
    <input type="file" id="changeMsgImgInput" accept="image/*" style="display:none" onchange="handleChangeMsgImgSelect(this)">

    <script>
        const DEFAULT_AVATAR = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAMAAABHPGVmAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRFzMzM////040qqAAAAAJ0Uk5T/wDltzBKAAAAJklEQVR42uzBgQAAAACAop/6QlVAAAAAAAAAAAAAAAAAAACwdQYMwAABnM7V7AAAAABJRU5ErkJggg==";
        
        const ao3Css = `
#workskin .phone-container { width: 350px; height: 650px; margin: 0 auto; border: 1px solid #ddd; border-radius: 10px; overflow: hidden; font-family: sans-serif; position: relative; display: flex; flex-direction: column; background-color: #f5f5f5; }
#workskin .skin-wechat { background-color: #ededed; }
#workskin .skin-wechat .header { background-color: #ededed; color: #000; border-bottom: 1px solid #dcdcdc; }
#workskin .skin-wechat .scrollable-content { background-color: #ededed; }
#workskin .skin-wechat .bubble.mine { background-color: #95ec69; color: #000; border: 1px solid #8ad961; }
#workskin .skin-wechat .bubble.other { background-color: #fff; color: #000; border: 1px solid #e0e0e0; }
#workskin .skin-qq { background-color: #f2f4f5; }
#workskin .skin-qq .header { background-color: #fff; color: #000; border-bottom: 1px solid #eee; }
#workskin .skin-qq .scrollable-content { background-color: #f2f4f5; }
#workskin .skin-qq .bubble.mine { background-color: #cce9ff; color: #000; border: none; }
#workskin .skin-qq .bubble.other { background-color: #fff; color: #000; border: none; }
#workskin .header { padding: 0 15px; height: 50px; flex-shrink: 0; z-index: 10; display: flex; align-items: center; justify-content: space-between; position: relative; }
#workskin .skin-wechat .header-title { position: absolute; left: 50%; transform: translateX(-50%); text-align: center; width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
#workskin .header-left { display: flex; align-items: center; }
#workskin .header-title { font-size: 17px; font-weight: bold; margin-right: 5px; }
#workskin .status-icon { font-size: 14px; cursor: default; }
#workskin .header-menu { font-size: 20px; font-weight: bold; letter-spacing: 2px; color: #333; z-index: 11; }
#workskin .header p { margin: 0; padding: 0; display: inline; }
#workskin .scrollable-content { overflow-y: auto; padding: 15px 12px; flex-grow: 1; display: flex; flex-direction: column; }
#workskin .msg-row { display: flex; align-items: flex-start; margin-bottom: 8px; flex-shrink: 0; }
#workskin .msg-row.left { flex-direction: row; }
#workskin .msg-row.right { flex-direction: row-reverse; }
#workskin .msg-row p { margin: 0; padding: 0; }
#workskin .avatar-box { width: 40px; height: 40px; flex-shrink: 0; }
#workskin .msg-row.left .avatar-box { margin-right: 10px; }
#workskin .msg-row.right .avatar-box { margin-left: 10px; }
#workskin .avatar-box img { width: 40px; height: 40px; border-radius: 5px; border: none; display: block; }
#workskin .content-col { display: flex; flex-direction: column; max-width: 75%; }
#workskin .msg-row.left .content-col { align-items: flex-start; }
#workskin .msg-row.right .content-col { align-items: flex-end; }
#workskin .char-name { font-size: 12px; color: #999; margin-bottom: 2px; margin-left: 2px; line-height: 1.2; }
#workskin .msg-row.right .char-name { display: none; }
#workskin .bubble { padding: 9px 12px; border-radius: 8px; font-size: 15px; line-height: 1.4; word-wrap: break-word; display: inline-block; text-align: left; }
#workskin .bubble img { max-width: 100%; height: auto; border-radius: 4px; display: block; }
#workskin .bubble p { margin: 0; }
#workskin .audio-bubble { display: flex; align-items: center; min-width: 100px; cursor: default; padding: 8px 10px; }
#workskin .play-icon { width: 0; height: 0; border-top: 6px solid transparent; border-bottom: 6px solid transparent; border-left: 10px solid #000; margin-right: 8px; }
#workskin .wave-visual { font-family: monospace; font-weight: bold; letter-spacing: -2px; color: #000; opacity: 0.7; font-size: 14px; margin-right: 10px; }
#workskin .duration-text { font-size: 14px; color: #000; }
#workskin .transcribed-text { margin-top: 5px; background-color: #e5e5e5; color: #000; padding: 6px 8px; border-radius: 6px; font-size: 14px; line-height: 1.4; }
#workskin .bubble.redpacket { background-color: #fa9d3b !important; padding: 0 !important; width: 230px; border: none !important; display: flex; flex-direction: column; overflow: hidden; border-radius: 8px; }
#workskin .rp-content { padding: 15px; display: flex; align-items: center; }
#workskin .rp-icon { width: 34px; height: 42px; background-color: #e54d42; border-radius: 4px; position: relative; flex-shrink: 0; display: flex; justify-content: center; align-items: center; margin-right: 12px; }
#workskin .rp-icon::after { content: ""; width: 12px; height: 12px; background-color: #f8d757; border-radius: 50%; }
#workskin .rp-text { color: #fff; font-size: 16px; font-weight: 500; line-height: 1.2; }
#workskin .rp-footer { background-color: rgba(255,255,255,0.05); border-top: 1px solid rgba(255,255,255,0.15); padding: 4px 15px; color: rgba(255,255,255,0.8); font-size: 11px; }
#workskin .time-row { text-align: center; margin: 15px 0 10px 0; width: 100%; clear: both; display: flex; justify-content: center; }
#workskin .time-pill { background-color: rgba(0,0,0,0.15); color: #fff; font-size: 12px; padding: 3px 8px; border-radius: 4px; display: inline-block; max-width: 80%; }
#workskin .skin-wechat .time-pill { background-color: #dadddf; color: #787a7d; }
`;

        let characters = [
            { id: 1, name: "è§’è‰² A", side: "left", avatar: DEFAULT_AVATAR, type: 'local' },
            { id: 2, name: "è§’è‰² B (æˆ‘)", side: "right", avatar: DEFAULT_AVATAR, type: 'local' }
        ];
        let messages = [
             { senderId: 1, type: 'text', content: 'æ›´æ–°ï¼šç°åœ¨å¯ä»¥åœ¨è§’è‰²åˆ—è¡¨ç‚¹å‡»ã€ğŸ–¼ï¸ æ¢å¤´åƒã€‘ä¿®æ”¹å·²æœ‰è§’è‰²çš„ç«‹ç»˜äº†ã€‚' },
             { senderId: 2, type: 'image', url: DEFAULT_AVATAR },
             { senderId: 2, type: 'text', content: 'ğŸ‘† å¯¹äºå‘é”™çš„å›¾ç‰‡ï¼Œä¹Ÿå¯ä»¥åœ¨åˆ—è¡¨ä¸­ç‚¹å‡»ã€ğŸ–¼ï¸ æ¢æºã€‘è¿›è¡Œæ›¿æ¢ï¼Œæ”¯æŒ URL å’Œæœ¬åœ°æ–‡ä»¶ã€‚' }
        ];

        // ç”¨äºè·Ÿè¸ªå½“å‰æ­£åœ¨ç¼–è¾‘å“ªä¸ªè§’è‰²æˆ–æ¶ˆæ¯çš„å›¾ç‰‡
        let targetCharIdForEdit = null;
        let targetMsgIdxForEdit = null;

        window.onload = function() {
            renderCharSelect();
            renderCharListDisplay();
            renderAll();
            
            const el = document.getElementById('msgList');
            new Sortable(el, {
                animation: 150,
                handle: '.drag-handle', 
                ghostClass: 'ghost-class',
                onEnd: function (evt) {
                    const item = messages.splice(evt.oldIndex, 1)[0];
                    messages.splice(evt.newIndex, 0, item);
                    renderPreviewOnly(); 
                    setTimeout(renderMsgList, 0); 
                }
            });
        };

        function checkAvatarType() {
            let val = document.getElementById('charAvatar').value;
            let tip = document.getElementById('avatarTip');
            if(val.startsWith('data:image')) {
                tip.innerHTML = "<span style='color:#fd7e14'>ğŸŸ  æ£€æµ‹åˆ°æœ¬åœ°å›¾ç‰‡æ•°æ® (é€‚åˆç”Ÿæˆé•¿å›¾/HTMLæ–‡ä»¶)</span>";
            } else if (val.startsWith('http')) {
                tip.innerHTML = "<span style='color:#28a745'>ğŸŸ¢ æ£€æµ‹åˆ°å¤–é“¾ (é€‚åˆ AO3)</span>";
            } else {
                tip.innerHTML = "æç¤ºï¼šè¯·é€‰æ‹©å›¾ç‰‡æ¥æº";
            }
        }

        // 1. è§’è‰²å¤´åƒä¸Šä¼  (æ–°å¢è§’è‰²æ—¶)
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('charAvatar').value = e.target.result;
                    checkAvatarType();
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 2. èŠå¤©å›¾ç‰‡ä¸Šä¼  (å‘é€æ–°æ¶ˆæ¯æ—¶)
        function handleMsgImgSelect(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('imgUrl').value = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 3. ğŸ†• æ›¿æ¢å·²æœ‰è§’è‰²çš„å¤´åƒ (æœ¬åœ°æ–‡ä»¶é€‰æ‹©å›è°ƒ)
        function handleChangeCharAvatarSelect(input) {
            if (input.files && input.files[0] && targetCharIdForEdit !== null) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    let char = characters.find(c => c.id === targetCharIdForEdit);
                    if(char) {
                        char.avatar = e.target.result;
                        char.type = 'local'; // ç¡®è®¤ä¸ºæœ¬åœ°ç±»å‹
                        renderCharListDisplay();
                        renderAll();
                    }
                    targetCharIdForEdit = null; // é‡ç½®
                    input.value = ''; // æ¸…ç©º input é˜²æ­¢é‡å¤è§¦å‘
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 4. ğŸ†• æ›¿æ¢å·²æœ‰æ¶ˆæ¯çš„å›¾ç‰‡ (æœ¬åœ°æ–‡ä»¶é€‰æ‹©å›è°ƒ)
        function handleChangeMsgImgSelect(input) {
            if (input.files && input.files[0] && targetMsgIdxForEdit !== null) {
                 var reader = new FileReader();
                reader.onload = function (e) {
                    if(messages[targetMsgIdxForEdit]) {
                        messages[targetMsgIdxForEdit].url = e.target.result;
                        renderMsgList();
                        renderPreviewOnly();
                    }
                    targetMsgIdxForEdit = null; // é‡ç½®
                    input.value = ''; // æ¸…ç©º input
                }
                reader.readAsDataURL(input.files[0]);
            }
        }


        function toggleInput() {
            let t = document.getElementById('msgType').value;
            ['text','voice','image','redpacket','time'].forEach(id => document.getElementById('input-'+id).style.display = 'none');
            document.getElementById('input-'+t).style.display = 'block';
        }

        function addChar() {
            let name = document.getElementById('charName').value;
            let avatar = document.getElementById('charAvatar').value || DEFAULT_AVATAR;
            let side = document.getElementById('charSide').value;
            if(!name) return alert('è¯·è¾“å…¥è§’è‰²åå­—');

            let type = 'local';
            if (avatar.startsWith('http')) type = 'link';

            characters.push({id: Date.now(), name, side, avatar, type});
            renderCharSelect();
            renderCharListDisplay();
            document.getElementById('charName').value = '';
            document.getElementById('charAvatar').value = '';
            document.getElementById('avatarTip').innerText = "æç¤ºï¼šè¯·é€‰æ‹©å›¾ç‰‡æ¥æº";
        }

        // ç¼–è¾‘è§’è‰²åå­—
        function editCharName(id) {
            let char = characters.find(c => c.id === id);
            if (!char) return;
            let newName = prompt("è¯·è¾“å…¥æ–°çš„è§’è‰²åï¼š", char.name);
            if (newName !== null && newName.trim() !== "") {
                char.name = newName.trim();
                renderCharSelect();
                renderCharListDisplay();
                renderAll();
            }
        }

        // ğŸ†• è§¦å‘æ›¿æ¢è§’è‰²å¤´åƒ
        function triggerCharAvatarEdit(id) {
            let char = characters.find(c => c.id === id);
            if (!char) return;
            
            // ä¼˜å…ˆè¯¢é—® URL
            let newUrl = prompt("è¯·è¾“å…¥æ–°çš„å¤´åƒ URL (å¦‚æœæƒ³é€‰æ‹©æœ¬åœ°æ–‡ä»¶ï¼Œè¯·ç•™ç©ºå¹¶ç‚¹å‡»ç¡®å®š)ï¼š", char.avatar.startsWith('http') ? char.avatar : "");
            
            if (newUrl !== null) {
                if (newUrl.trim() !== "") {
                    // ç”¨æˆ·è¾“å…¥äº† URL
                    char.avatar = newUrl.trim();
                    char.type = 'link';
                    renderCharListDisplay();
                    renderAll();
                } else {
                    // ç”¨æˆ·ç•™ç©ºï¼Œè§¦å‘æœ¬åœ°æ–‡ä»¶é€‰æ‹©
                    targetCharIdForEdit = id;
                    document.getElementById('changeCharAvatarInput').click();
                }
            }
        }


        function deleteChar(id) {
            if(!confirm("ç¡®å®šåˆ é™¤è¯¥è§’è‰²å—ï¼Ÿå†å²æ¶ˆæ¯ä¸­è¯¥è§’è‰²å°†æ˜¾ç¤ºä¸º'æœªçŸ¥'ã€‚")) return;
            characters = characters.filter(c => c.id !== id);
            renderCharSelect();
            renderCharListDisplay();
            renderAll();
        }

        function renderCharListDisplay() {
            let container = document.getElementById('charListDisplay');
            container.innerHTML = '';
            characters.forEach(c => {
                let div = document.createElement('div');
                div.className = 'char-list-item';
                let tag = c.type === 'link' 
                    ? `<span class="tag tag-link">[å¤–é“¾]</span>` 
                    : `<span class="tag tag-local">[æœ¬åœ°]</span>`;
                // å¢åŠ äº† æ¢å¤´åƒ æŒ‰é’®
                div.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <img src="${c.avatar}" class="char-mini-av">
                        <div style="display:flex; flex-direction:column;">
                            <span>${c.name} (${c.side === 'left' ? 'å·¦' : 'å³'})</span>
                            <div style="margin-top:2px;">${tag}</div>
                        </div>
                    </div>
                    <div>
                        <button class="btn-edit" onclick="editCharName(${c.id})">âœï¸ æ”¹å</button>
                        <button class="btn-edit" onclick="triggerCharAvatarEdit(${c.id})">ğŸ–¼ï¸ æ¢å¤´åƒ</button>
                        <button class="btn-red-outline" onclick="deleteChar(${c.id})">åˆ </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderCharSelect() {
            let s = document.getElementById('senderSelect');
            let current = s.value;
            s.innerHTML = '';
            characters.forEach(c => s.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            if(current) s.value = current;
        }

        function sendMsg() {
            let sid = document.getElementById('senderSelect').value;
            let type = document.getElementById('msgType').value;
            
            if (type !== 'time' && !sid) return alert("è¯·å…ˆæ·»åŠ è§’è‰²");
            
            let data = { senderId: parseInt(sid || 0), type };
            
            if(type === 'text') {
                data.content = document.getElementById('textContent').value;
                document.getElementById('textContent').value = '';
            } else if (type === 'time') {
                data.content = document.getElementById('timeContent').value;
                document.getElementById('timeContent').value = '';
            } else if (type === 'redpacket') {
                data.main = document.getElementById('rpMain').value;
                data.sub = document.getElementById('rpSub').value;
            } else if (type === 'voice') {
                data.duration = document.getElementById('voiceDuration').value || '10"';
                data.text = document.getElementById('voiceText').value;
                document.getElementById('voiceText').value = '';
            } else if (type === 'image') {
                data.url = document.getElementById('imgUrl').value;
                document.getElementById('imgUrl').value = '';
                document.getElementById('msgImgUpload').value = ''; 
            }
            if(!data.content && !data.text && !data.url && !data.main) return;
            messages.push(data);
            renderAll();
        }

        // ğŸ†• è§¦å‘æ›¿æ¢æ¶ˆæ¯å›¾ç‰‡
        function triggerMsgImgEdit(idx) {
            let msg = messages[idx];
            if (!msg || msg.type !== 'image') return;

             // ä¼˜å…ˆè¯¢é—® URL
            let newUrl = prompt("è¯·è¾“å…¥æ–°çš„å›¾ç‰‡ URL (å¦‚æœæƒ³é€‰æ‹©æœ¬åœ°æ–‡ä»¶ï¼Œè¯·ç•™ç©ºå¹¶ç‚¹å‡»ç¡®å®š)ï¼š", msg.url.startsWith('http') ? msg.url : "");
            
            if (newUrl !== null) {
                if (newUrl.trim() !== "") {
                     // ç”¨æˆ·è¾“å…¥äº† URL
                    msg.url = newUrl.trim();
                    renderMsgList();
                    renderPreviewOnly();
                } else {
                    // ç”¨æˆ·ç•™ç©ºï¼Œè§¦å‘æœ¬åœ°æ–‡ä»¶é€‰æ‹©
                    targetMsgIdxForEdit = idx;
                    document.getElementById('changeMsgImgInput').click();
                }
            }
        }


        function renderMsgList() {
            let list = document.getElementById('msgList');
            list.innerHTML = '';
            messages.forEach((msg, idx) => {
                let txt = '';
                let charName = '';
                let editBtn = ''; // å›¾ç‰‡æ¶ˆæ¯çš„é¢å¤–ç¼–è¾‘æŒ‰é’®

                if (msg.type === 'time') {
                    charName = "ğŸ•’ ç³»ç»Ÿ";
                    txt = `[æ—¶é—´] ${msg.content}`;
                } else {
                    let char = characters.find(c => c.id === msg.senderId) || { name: "æœªçŸ¥" };
                    charName = char.name;
                    txt = msg.type==='text' ? msg.content : (msg.type==='redpacket' ? '[çº¢åŒ…]' : `[${msg.type}]`);
                    if(msg.type === 'image') {
                        txt = '[å›¾ç‰‡]';
                        // ä¸ºå›¾ç‰‡æ¶ˆæ¯æ·»åŠ æ¢æºæŒ‰é’®
                        editBtn = `<button class="btn-edit" style="margin-right:5px;" onclick="triggerMsgImgEdit(${idx})">ğŸ–¼ï¸ æ¢æº</button>`;
                    }
                }

                list.innerHTML += `
                <div class="msg-list-item" data-id="${idx}">
                    <div style="display:flex; align-items:center; flex:1; overflow:hidden;">
                        <span class="drag-handle">â˜°</span>
                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${charName}: ${txt}</span>
                    </div>
                    <div style="display:flex; align-items:center;">
                        ${editBtn}
                        <button style="color:red; width:auto; margin:0;" onclick="deleteMsg(${idx})">X</button>
                    </div>
                </div>`;
            });
        }

        function deleteMsg(idx) {
            messages.splice(idx, 1);
            renderAll();
        }

        function renderPreviewOnly() {
             let content = document.getElementById('chatContent');
             content.innerHTML = '';
             
             let theme = document.getElementById('themeSelect').value;
             document.getElementById('previewContainer').className = `phone-container ${theme}`;
             document.getElementById('dispTitle').innerText = document.getElementById('chatTitle').value;

            let statusVal = document.getElementById('statusSelect').value;
            let customDiv = document.getElementById('customStatusDiv');
            if (statusVal === 'custom') {
                customDiv.style.display = 'block';
                statusVal = document.getElementById('customStatusInput').value;
            } else {
                customDiv.style.display = 'none';
            }
            document.getElementById('dispStatus').innerText = statusVal;

             messages.forEach((msg) => {
                if (msg.type === 'time') {
                    content.innerHTML += `<div class="time-row"><span class="time-pill">${msg.content}</span></div>`;
                    return;
                }

                let char = characters.find(c => c.id === msg.senderId);
                if (!char) char = { name: "æœªçŸ¥", side: "left", avatar: DEFAULT_AVATAR, type: 'local' };
                let inner = '';
                
                if(msg.type === 'text') {
                    let safeText = msg.content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    inner = `<div class="bubble ${char.side === 'right' ? 'mine' : 'other'}">${safeText}</div>`;
                } else if (msg.type === 'redpacket') {
                    inner = `<div class="bubble redpacket"><div class="rp-content"><div class="rp-icon"></div><div class="rp-text">${msg.main}</div></div><div class="rp-footer">${msg.sub}</div></div>`;
                } else if (msg.type === 'voice') {
                    inner = `<div class="bubble audio-bubble ${char.side === 'right' ? 'mine' : 'other'}"><div class="play-icon"></div><div class="wave-visual">|||||||||||</div><div class="duration-text">${msg.duration}</div></div><div class="transcribed-text">${msg.text}</div>`;
                } else if (msg.type === 'image') {
                    inner = `<div class="bubble ${char.side === 'right' ? 'mine' : 'other'}"><img src="${msg.url}"></div>`;
                }

                let row = `
                    <div class="msg-row ${char.side}">
                        <div class="avatar-box"><img src="${char.avatar}"></div>
                        <div class="content-col">
                            <div class="char-name">${char.name}</div>
                            ${inner}
                        </div>
                    </div>
                `;
                content.innerHTML += row;
            });
            content.scrollTop = content.scrollHeight;
        }

        function renderAll() {
            renderPreviewOnly();
            renderMsgList();
        }

        function generateAO3Code() {
            let hasLocalAvatar = characters.some(c => c.type === 'local' && messages.some(m => m.senderId === c.id));
            let hasLocalMsgImg = messages.some(m => m.type === 'image' && m.url && m.url.startsWith('data:image'));

            if (hasLocalAvatar || hasLocalMsgImg) {
                let msg = "âš ï¸ è­¦å‘Šï¼šæ£€æµ‹åˆ°æ‚¨ä½¿ç”¨äº†ã€æœ¬åœ°å›¾ç‰‡ã€‘(å¤´åƒæˆ–èŠå¤©å›¾)ã€‚\n\n";
                msg += "AO3 ä¸æ”¯æŒæ˜¾ç¤ºç›´æ¥ç²˜è´´çš„æœ¬åœ°ä»£ç  (Base64)ã€‚\n";
                msg += "å‘å¸ƒåå›¾ç‰‡ä¼šè£‚å¼€æˆ–å˜æˆç©ºç™½ï¼\n\n";
                msg += "âœ… å»ºè®®ï¼šä½¿ç”¨ã€ğŸ–¼ï¸ å­˜ä¸ºå›¾ç‰‡ã€‘ç”Ÿæˆé•¿å›¾ï¼Œç›´æ¥å‘å›¾å³å¯ã€‚\n";
                msg += "âŒ å¦‚æœå¿…é¡»å¤åˆ¶ HTMLï¼Œè¯·ç¡®ä¿æ‰€æœ‰å›¾ç‰‡ä½¿ç”¨å¤–é“¾ (http...)ã€‚\n\n";
                msg += "æ˜¯å¦ä»ç„¶è¦å¼ºåˆ¶è·å–ä»£ç ï¼Ÿ";
                
                let confirm = window.confirm(msg);
                if (!confirm) return;
            }

            let html = document.getElementById('previewContainer').outerHTML;
            html = html.replace('id="previewContainer"', '')
                       .replace('id="dispTitle"', '')
                       .replace('id="dispStatus"', '')
                       .replace('id="chatContent"', '');
            document.getElementById('modalTitle').innerText = "AO3 HTML ä»£ç ";
            document.getElementById('modalDesc').innerText = "å¤åˆ¶åˆ° AO3 HTML ç¼–è¾‘å™¨ä¸­ã€‚";
            document.getElementById('finalCode').value = html;
            document.getElementById('codeModal').style.display = 'flex';
        }

        function downloadHTML() {
            let filename = document.getElementById('exportFilename').value || 'ao3_chat';
            if (!filename.endsWith('.html')) filename += '.html';

            let chatHtml = document.getElementById('previewContainer').outerHTML;
            chatHtml = chatHtml.replace('id="previewContainer"', '')
                               .replace('id="dispTitle"', '')
                               .replace('id="dispStatus"', '')
                               .replace('id="chatContent"', '');

            let fullHtml = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>${filename}</title>
<style>
${ao3Css}
body { background-color: #eef2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
#workskin { margin-top: 20px; margin-bottom: 20px; }
</style>
</head>
<body>
<div id="workskin">
${chatHtml}
</div>
</body>
</html>`;
            let blob = new Blob([fullHtml], {type: "text/html;charset=utf-8"});
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importHTML() {
            const html = document.getElementById('importArea').value;
            if(!html) return alert("è¯·è¾“å…¥ä»£ç ");

            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const container = doc.querySelector('.phone-container');
                if(container) {
                    if(container.classList.contains('skin-wechat')) document.getElementById('themeSelect').value = 'skin-wechat';
                    else document.getElementById('themeSelect').value = 'skin-qq';
                }

                const titleEl = doc.querySelector('.header-title');
                if(titleEl) document.getElementById('chatTitle').value = titleEl.innerText.trim();

                characters = [];
                messages = [];
                
                const allRows = doc.querySelectorAll('.msg-row, .time-row');
                
                if (allRows.length === 0) {
                    alert("æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„æ¶ˆæ¯è®°å½•ï¼Œè¯·æ£€æŸ¥ä»£ç æ˜¯å¦å®Œæ•´ã€‚");
                    return;
                }

                allRows.forEach(row => {
                    if (row.classList.contains('time-row')) {
                        const timeText = row.innerText.trim();
                        messages.push({ senderId: 0, type: 'time', content: timeText });
                        return;
                    }

                    const isLeft = row.classList.contains('left');
                    const imgEl = row.querySelector('.avatar-box img');
                    const avatar = imgEl ? imgEl.src : DEFAULT_AVATAR;
                    
                    let name = "æœªçŸ¥";
                    const nameEl = row.querySelector('.char-name');
                    if(nameEl) name = nameEl.innerText.trim();
                    else if(!isLeft) name = "æˆ‘";

                    let exists = characters.find(c => c.name === name && c.avatar === avatar);
                    let sid;
                    if(!exists) {
                        sid = Date.now() + Math.floor(Math.random()*10000);
                        let type = avatar.startsWith('http') ? 'link' : 'local';
                        characters.push({ id: sid, name, side: isLeft ? 'left' : 'right', avatar, type });
                    } else {
                        sid = exists.id;
                    }

                    if(row.querySelector('.redpacket')) {
                        const rpText = row.querySelector('.rp-text').innerText.trim();
                        const rpFoot = row.querySelector('.rp-footer').innerText.trim();
                        messages.push({ senderId: sid, type: 'redpacket', main: rpText, sub: rpFoot });
                    } else if(row.querySelector('.audio-bubble')) {
                        const dur = row.querySelector('.duration-text').innerText.trim();
                        const trans = row.querySelector('.transcribed-text').innerText.trim();
                        messages.push({ senderId: sid, type: 'voice', duration: dur, text: trans });
                    } else if(row.querySelector('.bubble img')) {
                        const src = row.querySelector('.bubble img').src;
                        messages.push({ senderId: sid, type: 'image', url: src });
                    } else {
                        const bubbleEl = row.querySelector('.bubble');
                        const txt = bubbleEl ? bubbleEl.innerText.trim() : "";
                        messages.push({ senderId: sid, type: 'text', content: txt });
                    }
                });

                renderCharSelect();
                renderCharListDisplay();
                renderAll();
                alert(`å¯¼å…¥æˆåŠŸï¼æ¢å¤äº† ${characters.length} ä¸ªè§’è‰²å’Œ ${messages.length} æ¡æ¶ˆæ¯ã€‚`);

            } catch (e) {
                console.error(e);
                alert("è§£æå‡ºé”™ï¼Œè¯·æ£€æŸ¥ä»£ç æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚\n\né”™è¯¯ä¿¡æ¯ï¼š" + e.message);
            }
        }

        function showCSS() {
            document.getElementById('modalTitle').innerText = "Work Skin CSS";
            document.getElementById('modalDesc').innerText = "å¤åˆ¶åˆ° AO3 Skin é¡µé¢ã€‚";
            document.getElementById('finalCode').value = ao3Css;
            document.getElementById('codeModal').style.display = 'flex';
        }

        function copyCode() {
            document.getElementById('finalCode').select();
            document.execCommand('copy');
            alert('å·²å¤åˆ¶');
        }
        
        function saveImage() {
            let filename = document.getElementById('exportFilename').value || 'chat_log';
            if (typeof html2canvas === 'undefined') return alert("æ’ä»¶æœªåŠ è½½");

            let container = document.querySelector(".phone-container");
            let content = document.querySelector(".scrollable-content");
            
            let originalHeight = container.style.height;
            let originalOverflow = content.style.overflowY;

            container.style.height = "auto"; 
            content.style.overflowY = "visible";

            html2canvas(document.querySelector("#workskin"), { 
                useCORS: true, 
                scale: 2,
                windowHeight: document.querySelector("#workskin").scrollHeight 
            }).then(canvas => {
                container.style.height = originalHeight;
                content.style.overflowY = originalOverflow;

                let a = document.createElement('a');
                a.download = filename + '.png';
                a.href = canvas.toDataURL();
                a.click();
            });
        }
    </script>
</body>
</html>
